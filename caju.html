<meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<link rel="manifest" href="./manifest.webmanifest">
<body />
<link rel="preconnect" href="https://fonts.gstatic.com">
<link href="https://fonts.googleapis.com/css2?family=Ubuntu+Condensed&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/@mdi/font@5.9.55/css/materialdesignicons.min.css" rel="stylesheet">
<style>
  body {
    font-family: 'Ubuntu Condensed', sans-serif;
    overflow-y: hidden;
  }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js"
  integrity="sha512-GZ1RIgZaSc8rnco/8CXfRdCpDxRCphenIiZ2ztLy3XQfCbQUSCuk8IudvNHxkRA3oUg6q0qejgN/qqyG1duv5Q=="
  crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
  navigator.serviceWorker.register('sw.js');
</script>
<script type="module">
  import {
    Coluna,
    Livro,
    Página,
    Navegação,
    VisualizadorHTML,
    Texto,
    CampoDeTexto,
    BarraDeTopo,
    Espaço,
    Ícone,
    solicite_escolha,
  } from "./caju-aplicativo.js"
  import {
    Comando,
  } from "./caju.js"
  var leiaute = new Coluna(0, 0, 0)
  leiaute.largura = "100%"
  leiaute.altura = "100%"
  var topo
  leiaute.adicione(topo = new BarraDeTopo())
  var abrir
  topo.adicione(abrir = new Ícone("folder-open-outline"))
  abrir.ao_clicar(() => {
    var input = document.createElement("input")
    input.type = "file"
    input.click()
    input.addEventListener("change", evento => {
      var leitor = new FileReader()
      leitor.addEventListener("load", evento => {
        var comandos = JSON.parse(evento.target.result).slice(1)
        ;(async () => {
          for (var i = 0; i < comandos.length; i++) {
            var comando = Comando.novo(comandos[i])
            coluna_código.adicione(comando)
            await comando.carregamento
          }
        })()
      })
      leitor.readAsText(evento.target.files[0])
    })
  })
  var salvar
  topo.adicione(salvar = new Ícone("content-save-outline"))
  salvar.ao_clicar(() => {
    var a = document.createElement("a")
    a.href = URL.createObjectURL(new Blob([JSON.stringify(["0.2.0", ...[...coluna_código.e.children].map(comando => comando.c.estruture())])], {type: "application/json"}))
    a.download = "projeto.caju"
    a.click()
  })
  topo.adicione(new Espaço())
  var deletar
  topo.adicione(deletar = new Ícone("delete"))
  deletar.e.style.color = "#909090"
  deletar.e.addEventListener("mousedown", evento => {
    evento.preventDefault()
    if (Comando.selecionado !== undefined) {
      Comando.selecionado.e.parentElement.removeChild(Comando.selecionado.e)
    }
  })
  var duplicar
  topo.adicione(duplicar = new Ícone("content-duplicate"))
  duplicar.e.style.color = "#909090"
  duplicar.e.addEventListener("mousedown", evento => {
    evento.preventDefault()
    if (Comando.selecionado !== undefined) {
      var selecionado = Comando.selecionado
      var novo_comando = Comando.novo(Comando.selecionado.estruture())
      selecionado.e.insertAdjacentElement("afterend", novo_comando.e)
    }
  })
  var mover
  topo.adicione(mover = new Ícone("elevator-up"))
  mover.e.style.color = "#909090"
  mover.e.addEventListener("mousedown", evento => {
    evento.preventDefault()
    if (Comando.selecionado.e.previousElementSibling !== null) {
      Comando.selecionado.e.insertAdjacentElement("afterend", Comando.selecionado.e.previousElementSibling)
    }
  })
  var adicionar
  topo.adicione(adicionar = new Ícone("plus"))
  adicionar.e.addEventListener("mousedown", evento => {
    evento.preventDefault()
    if (Comando.selecionado !== undefined) {
      if (Comando.selecionado.constructor.aceita !== undefined) {
        if (Comando.selecionado.constructor.aceita.length > 0) {
          Comando.selecionado.solicite_inclusão_de_comando()
        }
      }
    } else {
      solicite_escolha([
        ["#d7ab32", "Aplicativo", "Aplicativo"],
        ...Comando.tipos.filter(Comando => Comando.retorna == "caju.global").map(Comando => [
          Comando.cor,
          Comando.nome,
          Comando,
        ]),
      ], Tipo => {
        if (Tipo == "Aplicativo") {
          coluna_código.adicione(Comando.novo([
            "caju.importe",
            [
              [
                "caju.texto",
                "https://cajueiro.herokuapp.com/angelonuffer/aplicativo/desenvolvimento/aplicativo.caju"
              ],
            ],
          ]))
          Comando.ao_definir("Aplicativo", () => {
            coluna_código.adicione(Comando.novo(["Aplicativo"]))
          })
          return
        }
        coluna_código.adicione(new Tipo())
      })
    }
  })
  Comando.ao_selecionar(() => {
    deletar.e.style.color = "#FFFFFF"
    duplicar.e.style.color = "#FFFFFF"
    if (Comando.selecionado.e.previousElementSibling !== null) {
      mover.e.style.color = "#FFFFFF"
    }
    if (Comando.selecionado.constructor.aceita === undefined) {
      adicionar.e.style.color = "#909090"
    } else {
      if (Comando.selecionado.constructor.aceita.length == 0) {
        adicionar.e.style.color = "#909090"
      }
    }
  })
  Comando.ao_desselecionar(() => {
    deletar.e.style.color = "#909090"
    duplicar.e.style.color = "#909090"
    mover.e.style.color = "#909090"
    adicionar.e.style.color = "#FFFFFF"
  })
  var livro
  leiaute.adicione(livro = new Livro())
  livro.crescimento = 1
  livro.excesso = "rolar"
  livro.margem = 16
  var código
  livro.adicione(código = new Página())
  var coluna_código
  código.adicione(coluna_código = new Coluna(0, 0, 16))
  var navegação
  leiaute.adicione(navegação = new Navegação(["code-json", "eye"]))
  var página_pré_visualizar
  livro.adicione(página_pré_visualizar = new Página())
  página_pré_visualizar.crescimento = 1
  página_pré_visualizar.e.style.alignItems = ""
  var pré_visualizar
  página_pré_visualizar.adicione(pré_visualizar = new VisualizadorHTML())
  pré_visualizar.espessura_da_borda = 3
  navegação.ao_trocar((i) => {
    if (i == 0) {
      abrir.mostre()
      salvar.mostre()
      adicionar.mostre()
    }
    if (i == 1) {
      var globais = {
        "caju.saída": "",
      }
      ;[...coluna_código.e.children].map(comando => comando.c.avalie(globais))
      pré_visualizar.e.src = URL.createObjectURL(new Blob([globais["caju.saída"]], {type: "text/html"}))
      abrir.esconda()
      salvar.esconda()
      adicionar.esconda()
    }
    livro.vá.bind(livro)(i)
  })
  document.body.appendChild(leiaute.e)
  document.body.style.margin = 0
</script>
