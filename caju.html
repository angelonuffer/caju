<meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<link rel="manifest" href="./manifest.webmanifest">
<body>
  <span id="corpo">
    <span id="livro">
      <span class="página" id="arquivos">
        <span class="barra_de_topo">
          <span class="mdi mdi-file-plus-outline"></span>
          <span class="mdi mdi-folder-plus-outline"></span>
          <span class="mdi mdi-github"></span>
        </span>
        <span id="caminho">
          <span class="mdi mdi-file-tree-outline"></span>
        </span>
        <span id="lista_de_arquivos"></span>
      </span>
      <span class="página" id="código">
        <span class="barra_de_topo">
          <span class="mdi mdi-content-paste"></span>
          <span class="mdi mdi-plus"></span>
        </span>
        <span></span>
      </span>
      <span class="página" id="visualizar"></span>
    </span>
    <span id="barra_de_navegação">
      <span class="mdi mdi-file-cabinet"></span>
      <span class="mdi mdi-code-json"></span>
      <span class="mdi mdi-eye"></span>
    </span>
  </span>
  <span id="fundo"></span>
  <span id="diálogo"></span>
</body>
<link rel="preconnect" href="https://fonts.gstatic.com">
<link href="https://fonts.googleapis.com/css2?family=Ubuntu+Condensed&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/@mdi/font@5.9.55/css/materialdesignicons.min.css" rel="stylesheet">
<style>
  body {
    font-family: 'Ubuntu Condensed', sans-serif;
    overflow-y: hidden;
    margin: 0;
  }
  #corpo {
    height: 100%;
    display: flex;
    flex-direction: column;
  }
  #livro {
    display: flex;
    flex-grow: 1;
  }
  .página {
    display: none;
    flex-direction: column;
    flex-grow: 1;
    width: -webkit-fill-available;
  }
  .barra_de_topo {
    background-color: #fd4659;
    color: #fff;
    font-size: 24px;
    display: flex;
    justify-content: flex-end;
  }
  .barra_de_topo span {
    padding: 12px;
  }
  #caminho {
    font-size: 24px;
    display: flex;
    padding-left: 12px;
    padding-right: 12px;
    align-items: baseline;
    overflow-x: scroll;
  }
  #caminho span {
    padding-top: 12px;
    padding-bottom: 12px;
  }
  #lista_de_arquivos {
    display: flex;
    flex-direction: column;
    font-size: 24px;
  }
  #lista_de_arquivos > span {
    display: flex;
    align-items: baseline;
  }
  #lista_de_arquivos span.mdi {
    padding: 12px;
  }
  #lista_de_arquivos span.nome {
    padding: 12px;
    flex-grow: 1;
  }
  #barra_de_navegação {
    background-color: #fd4659;
    color: #ffffffbf;
    font-size: 24px;
    display: flex;
  }
  #barra_de_navegação span {
    padding: 12px;
    flex-grow: 1;
    display: flex;
    justify-content: center;
  }
  #fundo {
    background-color: #00000088;
    position: fixed;
    top: 0;
    bottom: 0;
    left: 0;
    right: 0;
    display: none;
  }
  #diálogo {
    background-color: #fff;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    max-height: 80%;
    overflow-y: scroll;
  }
  .branch {
    background-color: hsl(199, 100%, 93%);
    border-radius: 50vh;
    padding-left: 12px;
    padding-right: 12px;
    font-size: 18px;
  }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js"
  integrity="sha512-GZ1RIgZaSc8rnco/8CXfRdCpDxRCphenIiZ2ztLy3XQfCbQUSCuk8IudvNHxkRA3oUg6q0qejgN/qqyG1duv5Q=="
  crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha256/0.9.0/sha256.min.js"
  integrity="sha512-szJ5FSo9hEmXXe7b5AUVtn/WnL8a5VofnFeYC2i2z03uS2LhAch7ewNLbl5flsEmTTimMN0enBZg/3sQ+YOSzQ=="
  crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
  var botões_de_navegação = [
    [
      document.querySelector("span.mdi-file-cabinet"),
      document.querySelector("span.página#arquivos"),
    ],
    [
      document.querySelector("span.mdi-code-json"),
      document.querySelector("span.página#código"),
    ],
    [
      document.querySelector("span.mdi-eye"),
      document.querySelector("span.página#visualizar"),
    ],
  ]
  botões_de_navegação.map(([botão, página]) => {
    botão.addEventListener("click", () => {
      botões_de_navegação.map(([botão, página]) => {
        botão.style.color = ""
        página.style.display = ""
      })
      botão.style.color = "#fff"
      página.style.display = "flex"
    })
  })
  botões_de_navegação[0][0].click()
  var descarregue_arquivo = (conteúdo) => {
    conteúdo = JSON.stringify(conteúdo)
    var endereço = "sha256:" + sha256(conteúdo)
    localStorage[endereço] = conteúdo
    return endereço
  }
  var carregue_arquivo = (endereço) => {
    return JSON.parse(localStorage[endereço])
  }
  if (localStorage["caju:raiz"] === undefined) {
    localStorage["caju:raiz"] = descarregue_arquivo([])
  }
  var span_fundo = document.querySelector("span#fundo")
  var span_diálogo = document.querySelector("span#diálogo")
  var solicite_escolha = opções => {
    span_fundo.style.display = "block"
    span_diálogo.style.flexDirection = "column"
    span_diálogo.style.display = "flex"
    return new Promise(resolva => {
      if (opções.filter(opção => opção[0] == "opção").length == 1) {
        span_fundo.style.display = "none"
        span_diálogo.style.display = "none"
        span_diálogo.textContent = ""
        opções.forEach(opção => {
          if (opção[0] == "opção") {
            if (opção[3] !== undefined) {
              resolva(opção[3])
            } else {
              resolva(opção[2])
            }
          }
        })
        return
      }
      opções.forEach(opção => {
        var span = document.createElement("span")
        span_diálogo.appendChild(span)
        span.style.display = "flex"
        span.style.alignItems = "baseline";
        span.style.paddingRight = "12px"
        if (opção[0] == "título") {
          span.style.paddingLeft = "12px"
          span.textContent = opção[1]
          span.style.fontSize = "32px"
          return
        }
        if (opção[0] == "opção") {
          var span_ícone = document.createElement("span")
          span.appendChild(span_ícone)
          span_ícone.classList.add("mdi")
          span_ícone.classList.add("mdi-" + opção[1])
          span_ícone.style.fontSize = "24px"
          span_ícone.style.padding = "12px"
          var span_texto = document.createElement("span")
          span.appendChild(span_texto)
          span_texto.style.fontSize = "24px"
          span_texto.textContent = opção[2]
          span.addEventListener("click", () => {
            span_fundo.style.display = "none"
            span_diálogo.style.display = "none"
            span_diálogo.textContent = ""
            if (opção[3] !== undefined) {
              resolva(opção[3])
            } else {
              resolva(opção[2])
            }
          })
          return
        }
      })
    })
  }
  var pergunte_nome_para_o_arquivo = (nome_atual) => {
    var nome = prompt("Nome do arquivo:", nome_atual)
    if (nome === null) {
      return null
    }
    if (! nome.endsWith(".caju")) {
      nome += ".caju"
    }
    return nome
  }
  var raiz = document.querySelector("span.mdi-file-tree-outline")
  raiz.endereço = localStorage["caju:raiz"]
  raiz.conteúdo = carregue_arquivo(raiz.endereço)
  var atual = raiz
  var span_caminho = document.querySelector("span#caminho")
  var span_lista_de_arquivos = document.querySelector("span#lista_de_arquivos")
  var atualize_lista_de_arquivos = () => {
    span_lista_de_arquivos.textContent = ""
    atual.conteúdo.forEach(([tipo, nome, endereço, branch], i) => {
      var span_arquivo = document.createElement("span")
      span_lista_de_arquivos.appendChild(span_arquivo)
      var span_ícone = document.createElement("span")
      span_arquivo.appendChild(span_ícone)
      span_ícone.classList.add("mdi")
      var span_nome = document.createElement("span")
      span_arquivo.appendChild(span_nome)
      if (tipo == "arquivo") {
        span_ícone.classList.add("mdi-file-document-outline")
      }
      if (tipo == "diretório") {
        span_ícone.classList.add("mdi-folder-outline")
      }
      if (tipo == "repositório") {
        span_ícone.classList.add("mdi-source-repository")
        var span_branch = document.createElement("span")
        span_arquivo.appendChild(span_branch)
        span_branch.classList.add("branch")
        span_branch.textContent = branch
      }
      if (tipo == "diretório" || tipo == "repositório") {
        span_nome.addEventListener("click", () => {
          var span_seta = document.createElement("span")
          span_caminho.appendChild(span_seta)
          span_seta.classList.add("mdi")
          span_seta.classList.add("mdi-chevron-right")
          var span_nome = document.createElement("span")
          span_caminho.appendChild(span_nome)
          span_nome.textContent = nome
          span_caminho.scrollLeft = span_caminho.scrollWidth
          atual.i = i
          atual = span_nome
          atual.endereço = endereço
          atual.conteúdo = carregue_arquivo(atual.endereço)
          atualize_lista_de_arquivos()
        })
      }
      span_nome.classList.add("nome")
      span_nome.textContent = nome
      var menu = document.createElement("span")
      span_arquivo.appendChild(menu)
      menu.classList.add("mdi")
      menu.classList.add("mdi-dots-vertical")
      menu.addEventListener("click", async () => {
        var ação = await solicite_escolha([
          ["título", nome],
          ["opção", "rename-box", "Renomear"],
          ["opção", "delete", "Deletar"],
        ])
        if (ação == "Renomear") {
          var novo_nome = null
          if (tipo == "arquivo") {
            novo_nome = pergunte_nome_para_o_arquivo(nome)
          }
          if (tipo == "diretório") {
            novo_nome = prompt("Nome do diretório:", nome)
          }
          if (novo_nome === null) {
            return
          }
          atual.conteúdo[i][1] = novo_nome
          atual.endereço = descarregue_arquivo(atual.conteúdo)
          var endereço_anterior = atual.endereço
          var diretório = atual
          while (diretório !== raiz) {
            diretório = diretório.previousElementSibling.previousElementSibling
            diretório.conteúdo[diretório.i][2] = endereço_anterior
            diretório.endereço = descarregue_arquivo(diretório.conteúdo)
            endereço_anterior = diretório.endereço
          }
          localStorage["caju:raiz"] = diretório.endereço
          atualize_lista_de_arquivos()
        }
        if (ação == "Deletar") {
          atual.conteúdo.splice(i, 1)
          atual.endereço = descarregue_arquivo(atual.conteúdo)
          var endereço_anterior = atual.endereço
          var diretório = atual
          while (diretório !== raiz) {
            diretório = diretório.previousElementSibling.previousElementSibling
            diretório.conteúdo[diretório.i][2] = endereço_anterior
            diretório.endereço = descarregue_arquivo(diretório.conteúdo)
            endereço_anterior = diretório.endereço
          }
          localStorage["caju:raiz"] = diretório.endereço
          atualize_lista_de_arquivos()
        }
      })
    })
  }
  atualize_lista_de_arquivos()
  var atualize_diretório = () => {
    atual.endereço = descarregue_arquivo(atual.conteúdo)
    var endereço_anterior = atual.endereço
    var diretório = atual
    while (diretório !== raiz) {
      diretório = diretório.previousElementSibling.previousElementSibling
      diretório.conteúdo[diretório.i][2] = endereço_anterior
      diretório.endereço = descarregue_arquivo(diretório.conteúdo)
      endereço_anterior = diretório.endereço
    }
    localStorage["caju:raiz"] = diretório.endereço
    atualize_lista_de_arquivos()
  }
  document.querySelector("span.mdi-file-plus-outline").addEventListener("click", () => {
    var nome = pergunte_nome_para_o_arquivo()
    if (nome === null) {
      return
    }
    var endereço = descarregue_arquivo(["0.3.0"])
    atual.conteúdo.push(["arquivo", nome, endereço])
    atualize_diretório()
  })
  document.querySelector("span.mdi-folder-plus-outline").addEventListener("click", () => {
    var nome = prompt("Nome do diretório:")
    if (nome === null) {
      return
    }
    var endereço = descarregue_arquivo([])
    atual.conteúdo.push(["diretório", nome, endereço])
    atualize_diretório()
  })
  var github = async (caminho) => {
    if (! caminho.startsWith("https://api.github.com")) {
      caminho = "https://api.github.com" + caminho
    }
    if (localStorage["caju:github_token"] === undefined) {
      localStorage["caju:github_token"] = prompt("Github token:")
    }
    var r = await fetch(caminho, {
      headers: {
        Authorization: "token " + localStorage["caju:github_token"],
      },
    })
    return await r.json()
  }
  document.querySelector("span.mdi-github").addEventListener("click", async () => {
    var ação = await solicite_escolha([
      ["título", "Github"],
      ["opção", "sheep", "Clonar"],
      ["opção", "form-textbox-password", "Atualizar token"],
    ])
    if (ação == "Clonar") {
      var usuário = await github("/user")
      var repositórios = await github("/users/" + usuário.login + "/repos?sort=pushed")
      var repositório = await solicite_escolha([
        ["título", "Clonar repositório"],
        ...repositórios.map(repositório => ["opção", "source-repository", repositório.name]),
      ])
      var branches = await github("/repos/" + usuário.login + "/" + repositório + "/git/matching-refs/")
      var branch = await solicite_escolha([
        ["título", repositório],
        ...branches.map(branch => [branch.ref.split("/"), branch.object.url])
          .filter(branch => branch[0][1] == "heads")
          .map(branch => ["opção", "source-branch", branch[0][2], branch]),
      ])
      var commit = await github(branch[1])
      var árvore = await github(commit.tree.url)
      var leia_árvore = async árvore => {
        return Promise.all(árvore.tree.map(async arquivo => {
          if (arquivo.type == "blob") {
            return ["arquivo", arquivo.path, descarregue_arquivo("")]
          }
          if (arquivo.type == "tree") {
            var árvore = await github(arquivo.url)
            return ["diretório", arquivo.path, descarregue_arquivo(await leia_árvore(árvore))]
          }
        }))
      }
      var endereço = descarregue_arquivo(await leia_árvore(árvore))
      atual.conteúdo.push(["repositório", repositório, endereço, branch[0][2]])
      atualize_diretório()
    }
    if (ação == "Atualizar token") {
      localStorage["caju:github_token"] = prompt("Github token:")
    }
  })
  document.querySelector("#caminho").addEventListener("click", evento => {
    if (evento.target.endereço === undefined) {
      return
    }
    while (atual !== evento.target) {
      atual = atual.previousElementSibling.previousElementSibling
      atual.parentElement.removeChild(atual.nextElementSibling)
      atual.parentElement.removeChild(atual.nextElementSibling)
    }
    atualize_lista_de_arquivos()
  })
  span_fundo.addEventListener("click", () => {
    span_fundo.style.display = "none"
    span_diálogo.style.display = "none"
    span_diálogo.textContent = ""
  })
</script>
